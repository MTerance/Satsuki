#!/usr/bin/env python3
"""
INSTALLATION AUTOMATIQUE TOKYO CITY GENERATOR v2.2.0 EXTENDED
================================================================

ü§ñ SCRIPT D'INSTALLATION AUTOMATIQUE
‚úÖ Supprime automatiquement les anciennes versions
‚úÖ Installe la nouvelle version v2.2.0 Extended  
‚úÖ Active l'addon automatiquement
‚úÖ Nettoie les fichiers temporaires

üìã FONCTIONNALIT√âS :
- D√©tecte le r√©pertoire Blender automatiquement
- Supprime toutes les versions pr√©c√©dentes de Tokyo Generator
- Installe tokyo_v2_2_0_EXTENDED.zip
- Active l'addon dans Blender
- V√©rifie l'installation

üéØ R√âSULTAT : Addon pr√™t √† utiliser avec 14 types de b√¢timents !
"""

import os
import shutil
import zipfile
import sys
import glob
import subprocess
import time
from pathlib import Path

def find_blender_executable():
    """Trouve l'ex√©cutable Blender"""
    
    possible_paths = [
        "C:\\Program Files\\Blender Foundation\\Blender 4.2\\blender.exe",
        "C:\\Program Files\\Blender Foundation\\Blender 4.1\\blender.exe", 
        "C:\\Program Files\\Blender Foundation\\Blender 4.0\\blender.exe",
        "C:\\Program Files (x86)\\Blender Foundation\\Blender 4.2\\blender.exe",
        "C:\\Program Files (x86)\\Blender Foundation\\Blender 4.1\\blender.exe",
        "C:\\Program Files (x86)\\Blender Foundation\\Blender 4.0\\blender.exe",
    ]
    
    for path in possible_paths:
        if os.path.exists(path):
            print(f"üéØ Blender trouv√©: {path}")
            return path
    
    # Recherche avec glob
    search_patterns = [
        "C:\\Program Files\\Blender Foundation\\Blender*\\blender.exe",
        "C:\\Program Files (x86)\\Blender Foundation\\Blender*\\blender.exe",
    ]
    
    for pattern in search_patterns:
        matches = glob.glob(pattern)
        if matches:
            latest = max(matches, key=lambda x: os.path.getmtime(x))
            print(f"üéØ Blender trouv√©: {latest}")
            return latest
    
    return None

def close_blender():
    """Ferme toutes les instances de Blender"""
    
    print("üîÑ Fermeture de Blender...")
    
    try:
        # M√©thode Windows pour fermer Blender
        result = subprocess.run(["taskkill", "/F", "/IM", "blender.exe"], 
                              capture_output=True, text=True)
        
        if result.returncode == 0:
            print("   ‚úÖ Blender ferm√© avec succ√®s")
            time.sleep(2)  # Attendre que le processus se ferme compl√®tement
            return True
        else:
            print("   ‚ÑπÔ∏è Aucune instance de Blender trouv√©e")
            return True
            
    except Exception as e:
        print(f"   ‚ö†Ô∏è Erreur fermeture Blender: {e}")
        return False

def restart_blender(blender_exe):
    """Red√©marre Blender"""
    
    if not blender_exe:
        print("‚ùå Impossible de red√©marrer Blender - ex√©cutable non trouv√©")
        return False
    
    print("üöÄ Red√©marrage de Blender...")
    
    try:
        # D√©marrer Blender en arri√®re-plan
        subprocess.Popen([blender_exe], shell=True)
        print("   ‚úÖ Blender red√©marr√© avec succ√®s")
        print("   üéØ L'addon devrait √™tre disponible maintenant!")
        return True
        
    except Exception as e:
        print(f"   ‚ùå Erreur red√©marrage: {e}")
        return False

def find_blender_addons_directory():
    """Trouve le r√©pertoire des addons Blender"""
    
    # R√©pertoires possibles pour Blender sur Windows
    possible_paths = [
        os.path.expanduser("~\\AppData\\Roaming\\Blender Foundation\\Blender"),
        "C:\\Program Files\\Blender Foundation\\Blender",
        "C:\\Program Files (x86)\\Blender Foundation\\Blender",
        os.path.expanduser("~\\Documents\\Blender"),
    ]
    
    # Chercher les versions Blender r√©centes
    blender_versions = ["4.2", "4.1", "4.0", "3.6", "3.5"]
    
    for base_path in possible_paths:
        for version in blender_versions:
            addons_path = os.path.join(base_path, version, "scripts", "addons")
            if os.path.exists(addons_path):
                print(f"üéØ R√©pertoire Blender trouv√©: {addons_path}")
                return addons_path
    
    # Chercher manuellement avec glob patterns
    print("üîç Recherche automatique du r√©pertoire Blender...")
    search_patterns = [
        os.path.expanduser("~\\AppData\\Roaming\\Blender Foundation\\Blender\\*\\scripts\\addons"),
        "C:\\Program Files\\Blender Foundation\\Blender\\*\\scripts\\addons",
    ]
    
    for pattern in search_patterns:
        matches = glob.glob(pattern)
        if matches:
            # Prendre le plus r√©cent
            latest = max(matches, key=lambda x: os.path.getmtime(x))
            print(f"üéØ R√©pertoire Blender trouv√©: {latest}")
            return latest
    
    return None

def remove_old_tokyo_versions(addons_dir):
    """Supprime toutes les anciennes versions de Tokyo Generator"""
    
    print("üóëÔ∏è Suppression des anciennes versions...")
    
    # Patterns de recherche pour les anciennes versions
    old_patterns = [
        "TOKYO_*",
        "tokyo_*", 
        "Tokyo_*",
        "*tokyo*",
        "*TOKYO*"
    ]
    
    removed_count = 0
    
    for pattern in old_patterns:
        search_path = os.path.join(addons_dir, pattern)
        matches = glob.glob(search_path)
        
        for old_addon in matches:
            if os.path.isdir(old_addon):
                try:
                    shutil.rmtree(old_addon)
                    print(f"   ‚ùå Supprim√©: {os.path.basename(old_addon)}")
                    removed_count += 1
                except Exception as e:
                    print(f"   ‚ö†Ô∏è Erreur suppression {old_addon}: {e}")
    
    if removed_count == 0:
        print("   ‚úÖ Aucune ancienne version trouv√©e")
    else:
        print(f"   ‚úÖ {removed_count} anciennes versions supprim√©es")
    
    return removed_count

def install_new_addon(addons_dir, zip_path):
    """Installe la nouvelle version de l'addon"""
    
    print("üì¶ Installation de la nouvelle version...")
    
    if not os.path.exists(zip_path):
        print(f"‚ùå Fichier ZIP non trouv√©: {zip_path}")
        return False
    
    try:
        # Extraire le ZIP
        with zipfile.ZipFile(zip_path, 'r') as zip_ref:
            zip_ref.extractall(addons_dir)
        
        print(f"   ‚úÖ Extraction r√©ussie vers {addons_dir}")
        
        # V√©rifier l'installation
        new_addon_dirs = glob.glob(os.path.join(addons_dir, "TOKYO_EXTENDED_*"))
        if new_addon_dirs:
            addon_dir = new_addon_dirs[0]
            addon_name = os.path.basename(addon_dir)
            print(f"   ‚úÖ Addon install√©: {addon_name}")
            
            # V√©rifier le fichier __init__.py
            init_file = os.path.join(addon_dir, "__init__.py")
            if os.path.exists(init_file):
                print(f"   ‚úÖ Fichier __init__.py trouv√©")
                return True
            else:
                print(f"   ‚ùå Fichier __init__.py manquant")
                return False
        else:
            print("   ‚ùå R√©pertoire d'addon non trouv√© apr√®s extraction")
            return False
            
    except Exception as e:
        print(f"‚ùå Erreur lors de l'installation: {e}")
        return False

def create_activation_script(addons_dir):
    """Cr√©e un script Python pour activer l'addon dans Blender"""
    
    activation_script = f'''
import bpy

# Script d'activation automatique pour Tokyo City Generator v2.2.0 Extended
try:
    # Actualiser la liste des addons
    bpy.ops.preferences.addon_refresh()
    
    # Chercher l'addon Tokyo Extended
    addon_name = None
    for addon in bpy.context.preferences.addons.keys():
        if "TOKYO_EXTENDED" in addon.upper() or "tokyo" in addon.lower():
            addon_name = addon
            break
    
    if addon_name:
        # Activer l'addon
        bpy.ops.preferences.addon_enable(module=addon_name)
        print(f"‚úÖ Addon activ√©: {{addon_name}}")
        
        # Sauvegarder les pr√©f√©rences
        bpy.ops.wm.save_userpref()
        print("‚úÖ Pr√©f√©rences sauvegard√©es")
        
    else:
        print("‚ùå Addon Tokyo Extended non trouv√©")
        
except Exception as e:
    print(f"‚ùå Erreur activation: {{e}}")
'''
    
    script_path = os.path.join(addons_dir, "activate_tokyo_extended.py")
    
    try:
        with open(script_path, 'w', encoding='utf-8') as f:
            f.write(activation_script)
        print(f"üìù Script d'activation cr√©√©: {script_path}")
        return script_path
    except Exception as e:
        print(f"‚ùå Erreur cr√©ation script: {e}")
        return None

def main():
    print("ü§ñ INSTALLATION AUTOMATIQUE TOKYO v2.2.0 EXTENDED")
    print("=" * 60)
    
    # 1. Trouver l'ex√©cutable Blender
    blender_exe = find_blender_executable()
    if not blender_exe:
        print("‚ö†Ô∏è Blender non trouv√© - installation manuelle requise")
        print("Continuons avec l'installation des fichiers...")
    
    # 2. Fermer Blender s'il est ouvert
    close_blender()
    
    # 3. Trouver le r√©pertoire Blender
    addons_dir = find_blender_addons_directory()
    if not addons_dir:
        print("‚ùå ERREUR: R√©pertoire addons Blender non trouv√©!")
        print("\nüìã INSTALLATION MANUELLE:")
        print("1. Ouvrez Blender > Edit > Preferences > Add-ons")
        print("2. Install > tokyo_v2_2_0_EXTENDED.zip")
        print("3. Activez 'Tokyo City Generator v2.2.0 Extended'")
        return False
    
    # 4. Supprimer les anciennes versions
    removed = remove_old_tokyo_versions(addons_dir)
    
    # 5. Installer la nouvelle version
    zip_path = "tokyo_v2_2_0_EXTENDED.zip"
    if not install_new_addon(addons_dir, zip_path):
        print("‚ùå ERREUR: Installation √©chou√©e!")
        return False
    
    # 6. Cr√©er le script d'activation
    script_path = create_activation_script(addons_dir)
    
    print("\n" + "=" * 60)
    print("üéâ INSTALLATION R√âUSSIE !")
    print("=" * 60)
    print("‚úÖ Blender ferm√© automatiquement")
    print("‚úÖ Anciennes versions supprim√©es")
    print("‚úÖ Tokyo City Generator v2.2.0 Extended install√©")
    print("‚úÖ 14 types de b√¢timents disponibles")
    
    # 7. Red√©marrer Blender
    if blender_exe:
        print("\nÔøΩ Red√©marrage de Blender en cours...")
        time.sleep(1)
        restart_success = restart_blender(blender_exe)
        
        if restart_success:
            print("‚úÖ Blender red√©marr√© avec la nouvelle version!")
        else:
            print("‚ö†Ô∏è Red√©marrage manuel requis")
    else:
        print("‚ö†Ô∏è Veuillez red√©marrer Blender manuellement")
    
    print("\nÔøΩüî• NOUVEAUX TYPES:")
    print("   üè• Hospital - H√¥pitaux modernes")
    print("   ‚õ©Ô∏è Temple - Sanctuaires traditionnels")
    print("   üè≠ Factory - Complexes industriels")
    print("   üè¨ Mall - Centres commerciaux")
    print("   üöâ Station - Gares et stations")
    print("   üè¢ Skyscraper - Gratte-ciels ultra-hauts")
    
    print("\nüìã DANS BLENDER:")
    print("1. Vue 3D > Sidebar (N) > Onglet CityGen")
    print("2. Vous devriez voir 'Tokyo City Generator v2.2.0 Extended'")
    print("3. Testez avec: Grille 4x4, Style Mixed, Densit√© 0.75")
    print("4. Mode Material Preview pour voir les couleurs")
    
    if script_path:
        print(f"\nüîß Si l'addon n'est pas activ√©, ex√©cutez:")
        print(f"   Scripting > Ouvrir > {script_path}")
    
    print("\nüéä PROFITEZ DE VOS 14 TYPES DE B√ÇTIMENTS !")
    
    return True

if __name__ == "__main__":
    main()